doctype html
html(lang="ko")
    head
        meta(charset='utf-8')
        title MBTI Guestbook
        meta(name='viewport', content='width=device-width, initial-scale=1')
        
        link(rel='stylesheet', href='https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css')
        link(rel='preconnect', href='https://fonts.googleapis.com')
        link(rel='preconnect', href='https://fonts.gstatic.com', crossorigin)
        link(href='https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap', rel='stylesheet')

        style.
            body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; color: #343a40; }
            .header { background-color: #ffffff; padding: 2rem 0; border-bottom: 1px solid #dee2e6; margin-bottom: 2rem; }
            .header h1 a { color: #343a40; font-weight: 700; text-decoration: none; }
            .test-container { background-color: #ffffff; border-radius: 15px; padding: 2rem 2.5rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07); margin-bottom: 2rem; }
            .question-block { margin-bottom: 1.75rem; }
            .question-block p { font-weight: 500; font-size: 1.1rem; margin-bottom: 0.75rem; }
            .btn-group-toggle .btn { border-radius: 20px !important; margin: 0 4px; font-size: 0.9rem; border-width: 1px; transition: all 0.2s ease-in-out; }
            .btn-group-toggle > .btn.active { background-color: #007bff; color: white; transform: scale(1.05); }
            #submitBtn, #showResultBtn { border-radius: 25px; padding: 10px 25px; font-weight: 500; }
            .card { border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); border: none; }
            .modal-content { border-radius: 15px; border: none; }
            .modal-header { border-bottom: none; }
            .modal-footer { border-top: none; }
            #modalResultText { font-size: 3.5rem; color: #007bff; }

    body
        .header
            .container.text-center
                h1
                    a(href='/') ë‹¹ì‹ ì˜ MBTIë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”
                div.mt-2
                    a(href='http://dshub.cloud').text-muted.mr-3 Myhome : DATASTORY.HUB
                    button#showResultBtn.btn.btn-sm.btn-outline-info(type="button", style="display:none;") ë‚´ ê²°ê³¼ ë‹¤ì‹œë³´ê¸°

        .container
            .test-container
                form#mbtiForm(action="/post", method="POST")
                    .progress.mb-4(style="height: 20px;")
                        #progressBar.progress-bar.bg-success.progress-bar-striped.progress-bar-animated(role="progressbar", style="width: 0%;") 0%
                    
                    hr.my-4

                    -
                        const questions = {
                            'E/I': ['ë‚˜ëŠ” ì‚¬ëžŒë“¤ê³¼ í•¨ê»˜ ìžˆì„ ë•Œ ì—ë„ˆì§€ë¥¼ ì–»ëŠ”ë‹¤.', 'ìƒˆë¡œìš´ ì‚¬ëžŒì„ ë§Œë‚˜ëŠ” ì‚¬êµ ëª¨ìž„ì„ ì¦ê¸´ë‹¤.', 'ì£¼ëª©ë°›ëŠ” ê²ƒì„ ì¦ê¸°ëŠ” íŽ¸ì´ë‹¤.', 'ìƒê°ì„ ë¨¼ì € ë§ë¡œ í‘œí˜„í•˜ëŠ” ê²½í–¥ì´ ìžˆë‹¤.', 'í™œë™ì ì´ê³  ì ê·¹ì ìœ¼ë¡œ ë‚˜ì„œëŠ” ê²ƒì„ ì„ í˜¸í•œë‹¤.'],
                            'S/N': ['ë‚˜ëŠ” ê²½í—˜ì„ í†µí•´ ë°°ìš°ëŠ” ê²ƒì„ ë” ì‹ ë¢°í•œë‹¤.', 'í˜„ìž¬ì˜ ì‚¬ì‹¤ê³¼ ì„¸ë¶€ì‚¬í•­ì— ì§‘ì¤‘í•˜ëŠ” íŽ¸ì´ë‹¤.', 'ì‹¤ìš©ì ì´ê³  í˜„ì‹¤ì ì¸ í•´ê²°ì±…ì„ ì„ í˜¸í•œë‹¤.', 'ë¹„ìœ ë‚˜ ì€ìœ ë³´ë‹¤ ëª…í™•í•˜ê³  ì§ì„¤ì ì¸ ì„¤ëª…ì„ ì¢‹ì•„í•œë‹¤.', 'ë‚˜ëŠ” ì˜¤ê°ì„ í†µí•´ ì–»ëŠ” ì •ë³´ë¥¼ ì¤‘ìš”í•˜ê²Œ ìƒê°í•œë‹¤.'],
                            'T/F': ['ë‚˜ëŠ” ê²°ì •ì„ ë‚´ë¦´ ë•Œ ê°ê´€ì ì¸ ì‚¬ì‹¤ê³¼ ë…¼ë¦¬ë¥¼ ìš°ì„ ì‹œí•œë‹¤.', 'ê³µì •ì„±ê³¼ ì›ì¹™ì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•œë‹¤.', 'ê°ì •ì ì¸ í˜¸ì†Œë³´ë‹¤ ë…¼ë¦¬ì ì¸ ë¶„ì„ì— ë” ì„¤ë“ëœë‹¤.', 'ë•Œë¡œëŠ” ì†”ì§í•œ ë¹„íŒì´ í•„ìš”í•˜ë‹¤ê³  ë¯¿ëŠ”ë‹¤.', 'ë¬¸ì œì˜ ì›ì¸ì„ ë¶„ì„í•˜ê³  í•´ê²°í•˜ëŠ” ê²ƒì„ ì¦ê¸´ë‹¤.'],
                            'J/P': ['ë‚˜ëŠ” ê³„íšì„ ì„¸ìš°ê³  ê·¸ê²ƒì„ ë”°ë¥´ëŠ” ê²ƒì„ ì¢‹ì•„í•œë‹¤.', 'ë§ˆê° ê¸°í•œì„ ì§€í‚¤ëŠ” ê²ƒì´ ë§¤ìš° ì¤‘ìš”í•˜ë‹¤.', 'ì •ë¦¬ì •ëˆëœ í™˜ê²½ì—ì„œ ì•ˆì •ê°ì„ ëŠë‚€ë‹¤.', 'ê²°ì •ì„ ë¹¨ë¦¬ ë‚´ë¦¬ê³  ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ëŠ” ê²ƒì„ ì„ í˜¸í•œë‹¤.', 'ì˜ˆì¸¡ ê°€ëŠ¥í•œ ìƒí™©ì„ ì¢‹ì•„í•˜ê³  ì¦‰í¥ì ì¸ ë³€í™”ë¥¼ í”¼í•˜ëŠ” íŽ¸ì´ë‹¤.']
                        };
                        let q_index = 0;

                    each categoryQuestions, category in questions
                        fieldset.my-4
                            legend.h5.mb-3 #{category}
                            each question in categoryQuestions
                                - q_index++
                                .question-block
                                    p #{q_index}. #{question}
                                    .btn-group.btn-group-toggle(data-toggle="buttons")
                                        label.btn.btn-outline-secondary
                                            input(type="radio", name=`q${q_index}`, value="-2", required)
                                            span ë§¤ìš° ì•„ë‹ˆë‹¤
                                        label.btn.btn-outline-secondary
                                            input(type="radio", name=`q${q_index}`, value="-1")
                                            span ì•„ë‹ˆë‹¤
                                        label.btn.btn-outline-secondary
                                            input(type="radio", name=`q${q_index}`, value="0")
                                            span ë³´í†µ
                                        label.btn.btn-outline-secondary
                                            input(type="radio", name=`q${q_index}`, value="1")
                                            span ê·¸ë ‡ë‹¤
                                        label.btn.btn-outline-secondary
                                            input(type="radio", name=`q${q_index}`, value="2")
                                            span ë§¤ìš° ê·¸ë ‡ë‹¤
                    
                    input(type="hidden", name="body", id="mbtiResultInput")
                    
                    //- --- style="display:none;"ì„ ì œê±°í•˜ì—¬ í•­ìƒ ë³´ì´ë„ë¡ ìˆ˜ì • ---
                    hr.my-4
                    div#final-inputs
                        h5.text-center.mb-3 ë§ˆì§€ë§‰ìœ¼ë¡œ ì •ë³´ë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”.
                        .row.justify-content-center
                            .col-md-5.mb-3
                                .input-group
                                    .input-group-prepend
                                        span.input-group-text Writer
                                    input#name.form-control(type="text", name="name", placeholder="ì´ë¦„ì„ ìž…ë ¥í•˜ì„¸ìš”", required)
                            .col-md-5.mb-3
                                .input-group
                                    .input-group-prepend
                                        span.input-group-text Date
                                    input#date.form-control(type="date", name="date", required)
                    //- ----------------------------------------------------

                    .text-center.mt-4
                        button#submitBtn.btn.btn-primary.btn-lg(type="submit", disabled) Pass to MongoDB

            hr

            section#post-list
                if messages.length > 0
                    h2.text-center.mb-4 ë°©ë¬¸ìž ê¸°ë¡
                    .row
                        each msg in messages
                            .col-md-6.col-lg-4.mb-4
                                .card
                                    .card-body
                                        h5.card-title #{msg.name}
                                        h6.card-subtitle.mb-2.text-muted #{msg.timeAgo}
                                        p.card-text.mt-3
                                            strong MBTI ê²°ê³¼: 
                                            span.badge.badge-success.p-2 #{msg.body}
                                        small.text-muted #{msg.date}
                else
                    .alert.alert-info(role='alert')
                        | ì•„ì§ ë“±ë¡ëœ ë°©ëª…ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”!
        
        #resultModal.modal.fade(tabindex="-1", role="dialog")
            .modal-dialog.modal-dialog-centered(role="document")
                .modal-content
                    .modal-header
                        h5.modal-title ðŸŽ‰ ë‹¹ì‹ ì˜ MBTI ê²°ê³¼ìž…ë‹ˆë‹¤!
                        button.close(type="button", data-dismiss="modal", aria-label="Close")
                            span(aria-hidden="true") &times;
                    .modal-body.text-center
                        p.lead ë‹¹ì‹ ì˜ ì„±í–¥ì„ ë‚˜íƒ€ë‚´ëŠ” ìœ í˜•ì€...
                        h1#modalResultText.font-weight-bold
                    .modal-footer
                        button.btn.btn-secondary(type="button", data-dismiss="modal") ë‹«ê¸°

        script(src='https://code.jquery.com/jquery-3.5.1.slim.min.js')
        script(src='https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js')
        script(src='https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js')

        script.
            document.addEventListener('DOMContentLoaded', () => {
                const totalQuestions = 20;
                const mbtiForm = document.getElementById('mbtiForm');
                const progressBar = document.getElementById('progressBar');
                const nameInput = document.getElementById('name');
                const dateInput = document.getElementById('date');
                const mbtiResultInput = document.getElementById('mbtiResultInput');
                const submitBtn = document.getElementById('submitBtn');
                const showResultBtn = document.getElementById('showResultBtn');
                const modalResultText = document.getElementById('modalResultText');
                
                if (localStorage.getItem('userMBTI')) {
                    showResultBtn.style.display = 'inline-block';
                }

                mbtiForm.addEventListener('change', () => {
                    updateProgress();
                    checkCompletion();
                });

                showResultBtn.addEventListener('click', () => {
                    const result = localStorage.getItem('userMBTI');
                    if (result) {
                        showResultModal(result);
                    }
                });
                
                function updateProgress() {
                    const checkedRadios = document.querySelectorAll('input[type="radio"]:checked');
                    const progress = (checkedRadios.length / totalQuestions) * 100;
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${Math.round(progress)}%`;
                }

                function checkCompletion() {
                    const allQuestionsAnswered = document.querySelectorAll('input[type="radio"]:checked').length === totalQuestions;
                    const writerFilled = nameInput.value.trim() !== '';
                    const dateFilled = dateInput.value !== '';

                    if (allQuestionsAnswered && writerFilled && dateFilled) {
                        const result = calculateMBTI();
                        
                        mbtiResultInput.value = result;
                        
                        const storedResult = localStorage.getItem('userMBTI');
                        if (result !== storedResult) {
                            localStorage.setItem('userMBTI', result);
                            showResultModal(result);
                        }

                        submitBtn.disabled = false;
                        showResultBtn.style.display = 'inline-block';

                    } else {
                        submitBtn.disabled = true;
                    }
                }

                function calculateMBTI() {
                    const scores = { E: 0, S: 0, T: 0, J: 0 };
                    for (let i = 1; i <= totalQuestions; i++) {
                        const value = parseInt(document.querySelector(`input[name="q${i}"]:checked`).value);
                        if (i <= 5) scores.E += value;
                        if (i > 5 && i <= 10) scores.S += value;
                        if (i > 10 && i <= 15) scores.T += value;
                        if (i > 15 && i <= 20) scores.J += value;
                    }

                    let result = '';
                    result += (scores.E > 0) ? 'E' : 'I';
                    result += (scores.S > 0) ? 'S' : 'N';
                    result += (scores.T > 0) ? 'T' : 'F';
                    result += (scores.J > 0) ? 'J' : 'P';
                    return result;
                }

                function showResultModal(result) {
                    modalResultText.textContent = result;
                    $('#resultModal').modal('show');
                }
            });
