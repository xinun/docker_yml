services:
  # --- 1. MongoDB (í˜¸ìŠ¤íŠ¸ 27017 í¬íŠ¸ ë…¸ì¶œ) ---
  mongodb:
    image: mongo:4 
    container_name: mongodb
    restart: always
    ports:
      # ğŸŒŸ [í•„ìˆ˜] í˜¸ìŠ¤íŠ¸(VM)ì˜ 27017 í¬íŠ¸ë¡œ MongoDBë¥¼ ë…¸ì¶œì‹œí‚µë‹ˆë‹¤.
      - "27017:27017"
    networks:
      - devapp-net
    volumes:
      - mongodb-data:/data/db 

  # --- 2. Backend (host ëª¨ë“œ, 8080 í¬íŠ¸ ì‚¬ìš©) ---
  backend:
    build: ./backend
    container_name: backend
    restart: always
    
    # ğŸŒŸ [1. ë³€ê²½] VPN(Redis) ì ‘ì†ì„ ìœ„í•´ 'host' ëª¨ë“œ ì‚¬ìš©
    network_mode: "host" 
    
    environment:
      # ğŸŒŸ [2. ë³€ê²½] í˜¸ìŠ¤íŠ¸ì˜ 8080 í¬íŠ¸ì—ì„œ ì‹¤í–‰
      - PORT=8080 
      # ğŸŒŸ [3. ë³€ê²½] í˜¸ìŠ¤íŠ¸ì˜ 127.0.0.1 (localhost)ì— ë…¸ì¶œëœ MongoDBë¡œ ì ‘ì†
      - GUESTBOOK_DB_ADDR=127.0.0.1:27017
      # ğŸŒŸ [4. ì¶”ê°€] utils/redis.jsê°€ ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜
      - REDIS_HOST=10.178.0.7
      - REDIS_PORT=6379
      - OPENAI_API_KEY=
      #
  # --- 3. Frontend (8000 í¬íŠ¸, backendì™€ í†µì‹ ) ---
  frontend:
    build: ./frontend
    container_name: frontend
    restart: always
    ports:
      # ğŸŒŸ VMì˜ 8000 í¬íŠ¸ì—ì„œ ì‹¤í–‰ (ê¸°ì¡´ê³¼ ë™ì¼)
      - "8000:80" 
    environment:
      - PORT=80
      # ğŸŒŸ [ì¤‘ìš”] 'frontend/app.js'ì˜ axiosê°€ ì´ ì£¼ì†Œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
      # 'host.docker.internal'ì€ ì»¨í…Œì´ë„ˆê°€ í˜¸ìŠ¤íŠ¸(VM)ë¥¼ ê°€ë¦¬í‚¤ëŠ” íŠ¹ìˆ˜ ì£¼ì†Œì…ë‹ˆë‹¤.
      - GUESTBOOK_API_ADDR=host.docker.internal:8080
    networks:
      - devapp-net
    # ğŸŒŸ [í•„ìˆ˜] 'host.docker.internal' ì£¼ì†Œë¥¼ í•´ì„í•˜ê¸° ìœ„í•´ ì¶”ê°€
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - mongodb
      
networks:
  devapp-net: {}

volumes:
  mongodb-data: {}

