# =========================================================
# 0. Namespaces (frontend / backend / db)
#    í•œ ë²ˆ ë§Œë“¤ì–´ë‘ë©´ ì´í›„ apply -f í•´ë„ ë‹¤ì‹œ ë§Œë“¤ë ¤ê³ ë§Œ í•˜ê³ , ì„œë¹„ìŠ¤ëŠ” ì•ˆ ëŠê¹€
# =========================================================
apiVersion: v1
kind: Namespace
metadata:
  name: frontend
  labels:
    name: frontend
---
apiVersion: v1
kind: Namespace
metadata:
  name: backend
  labels:
    name: backend
---
apiVersion: v1
kind: Namespace
metadata:
  name: db
  labels:
    name: db

# =========================================================
# 1. ì™¸ë¶€ Redis ë§¤í•‘ (Service + Endpoints)
#    â†’ backend ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì— ë‘¬ì„œ ë°±ì—”ë“œê°€ ë°”ë¡œ ì°¸ì¡°
#    â†’ backend ì•ˆì—ì„œ ì´ë¦„: redis-external.backend.svc.cluster.local
# =========================================================
---
apiVersion: v1
kind: Service
metadata:
  name: redis-external
  namespace: backend
spec:
  ports:
    - name: redis
      port: 6379
      targetPort: 6379
---
apiVersion: v1
kind: Endpoints
metadata:
  name: redis-external
  namespace: backend
subsets:
  - addresses:
      - ip: 10.178.0.7    # ë„ˆ ì™¸ë¶€ redis IP
    ports:
      - name: redis
        port: 6379
        protocol: TCP

# =========================================================
# 2. MongoDB (db ë„¤ì„ìŠ¤í˜ì´ìŠ¤)
#    service: mongodb.db.svc.cluster.local:27017
# =========================================================
---
apiVersion: v1
kind: Service
metadata:
  name: mongodb
  namespace: db
  labels:
    app: mongodb
spec:
  clusterIP: None
  selector:
    app: mongodb
  ports:
    - name: mongo
      port: 27017
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongodb
  namespace: db
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongodb
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      containers:
        - name: mongod
          image: mongo:4
          imagePullPolicy: IfNotPresent
          ports:
            - name: mongo
              containerPort: 27017
          volumeMounts:
            - name: data
              mountPath: /data/db
      volumes:
        - name: data
          emptyDir: {}   # í•„ìš”í•˜ë©´ PVCë¡œ êµì²´

# =========================================================
# 3. Backend (backend ë„¤ì„ìŠ¤í˜ì´ìŠ¤)
#    service: mbti-backend.backend.svc.cluster.local:8080
#    secret: mbti-saju-secrets (ì´ë¯¸ backend ns ì— ë§Œë“¤ì–´ë’€ë‹¤ê³  í–ˆìœ¼ë‹ˆê¹Œ ì•ˆ ë§Œë“¤ìŒ)
# =========================================================
---
apiVersion: v1
kind: Service
metadata:
  name: mbti-backend
  namespace: backend
spec:
  selector:
    app: mbti-backend
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mbti-backend
  namespace: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mbti-backend
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  template:
    metadata:
      labels:
        app: mbti-backend
    spec:
      containers:
        - name: app
          image: xinuun/mbti:backend_final
          imagePullPolicy: IfNotPresent
          env:
            - name: PORT
              value: "8080"

            # MongoDBëŠ” db ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê¸°ì¤€ìœ¼ë¡œ ì ‘ê·¼
            - name: MONGODB_URI
              value: "mongodb://mongodb.db.svc.cluster.local:27017/guestbook"
            - name: GUESTBOOK_DB_ADDR
              value: "mongodb.db.svc.cluster.local:27017"

            # RedisëŠ” backend ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆ
            - name: REDIS_ENABLED
              value: "true"
            - name: REDIS_HOST
              value: "redis-external.backend.svc.cluster.local"
            - name: REDIS_PORT
              value: "6379"

            # ì—¬ê¸° ìˆëŠ” ì‹œí¬ë¦¿ì€ ë„¤ê°€ backend ns ì— ì´ë¯¸ ë§Œë“¤ì–´ë†¨ë‹¤ê³  í–ˆìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ ì°¸ì¡°
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mbti-saju-secrets
                  key: OPENAI_API_KEY
          ports:
            - containerPort: 8080

# =========================================================
# 4. Frontend (frontend ë„¤ì„ìŠ¤í˜ì´ìŠ¤)
#    service: mbti-frontend.frontend.svc.cluster.local
#    í”„ë¡ íŠ¸ê°€ ë°±ì—”ë“œ í˜¸ì¶œí•  ë•ŒëŠ” backend ns ì˜ ì„œë¹„ìŠ¤ë¡œ í˜¸ì¶œí•´ì•¼ í•¨
# =========================================================
---
apiVersion: v1
kind: Service
metadata:
  name: mbti-frontend
  namespace: frontend
spec:
  selector:
    app: mbti-frontend
  ports:
    - name: http
      port: 80
      targetPort: 80
  type: NodePort
  # í•„ìš”í•˜ë©´ ê³ ì • í¬íŠ¸ë„ ì¤„ ìˆ˜ ìˆìŒ
  # nodePort: 30080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mbti-frontend
  namespace: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mbti-frontend
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  template:
    metadata:
      labels:
        app: mbti-frontend
    spec:
      containers:
        - name: web
          image: xinuun/mbti:frontend_final
          imagePullPolicy: IfNotPresent
          env:
            - name: PORT
              value: "80"
            # í”„ë¡ íŠ¸ê°€ í˜¸ì¶œí•  ë°±ì—”ë“œ ì£¼ì†Œë¥¼ ns í¬í•¨ìœ¼ë¡œ ë³€ê²½
            - name: GUESTBOOK_API_ADDR
              value: "mbti-backend.backend.svc.cluster.local:8080"
            # - name: BACKEND_URI 
            #   value: "http://mbti-backend.backend.svc.cluster.local:8080"
          ports:
            - containerPort: 80

# =========================================================
# 5. Ingress (ì™¸ë¶€ ë„ë©”ì¸ ì—°ê²°)
#    mbti.local/     -> frontend (frontend ns)
#    mbti.local/saju -> backend (backend ns)
# =========================================================
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: frontend-ing
  namespace: frontend
spec:
  ingressClassName: nginx
  rules:
    # [ìˆ˜ì •] "host: m-t-i.local" ì¤„ì„ ì‚­ì œ
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: mbti-frontend
                port:
                  number: 80
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: backend-ing
  namespace: backend # 2. backend IngressëŠ” backend ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ìƒì„±
  annotations:
    # ğŸŒŸ [ë‹µë³€] ë°”ë¡œ ì—¬ê¸°ì— ì¶”ê°€í•©ë‹ˆë‹¤.
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/rewrite-target: /api/analyze
    
spec:
  ingressClassName: nginx
  rules:
    # [ìˆ˜ì •] "host: m-t-i.local" ì¤„ì„ ì‚­ì œ
    - http:
        paths:
          - path: /saju-analyze
            pathType: Prefix
            backend:
              service:
                name: mbti-backend
                port:
                  number: 8080