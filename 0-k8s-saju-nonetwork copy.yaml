# =========================================
# MBTI-SAJU 3-Tier (NetworkPolicy Ï†úÍ±∞)
# =========================================

# ---------- Namespaces ----------
apiVersion: v1
kind: Namespace
metadata:
  name: frontend
  labels: { name: frontend }
---
apiVersion: v1
kind: Namespace
metadata:
  name: backend
  labels: { name: backend }
---
apiVersion: v1
kind: Namespace
metadata:
  name: db
  labels: { name: db }

# ========== 1) Secrets (OpenAI API ÌÇ§) ==========
---
apiVersion: v1
kind: Secret
metadata:
  name: openai-secret
  namespace: backend
type: Opaque
data:
  # üö® Base64Î°ú Ïù∏ÏΩîÎî©Îêú ÏÉà API ÌÇ§Î•º Ïó¨Í∏∞Ïóê Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî.
  OPENAI_API_KEY: <Base64Î°ú-Ïù∏ÏΩîÎî©Îêú-OpenAI-API-ÌÇ§>

# ========== 2) ÎÇ¥Î∂Ä Redis (Deployment + Service) ==========
---
apiVersion: v1
kind: Service
metadata:
  name: redis-external
  namespace: backend 
  labels: { app: redis }
spec:
  selector: { app: redis }
  ports:
  - name: redis
    port: 6379
    targetPort: 6379
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-external 
  namespace: backend
  labels: { app: redis }
spec:
  replicas: 1
  selector:
    matchLabels: { app: redis }
  template:
    metadata:
      labels: { app: redis }
    spec:
      containers:
        - name: redis
          image: redis:6-alpine
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 6379

# ========== 3) MongoDB ReplicaSet (3) ==========
# Headless Service (peer ÌÜµÏã†Ïö©)
---
apiVersion: v1
kind: Service
metadata:
  name: mongodb
  namespace: db
  labels: { app: mongodb }
spec:
  clusterIP: None
  selector: { app: mongodb }
  ports:
    - name: mongo
      port: 27017
      targetPort: 27017
---
# Client-facing Service (Î∞±ÏóîÎìúÏóêÏÑú Î∂ôÎäî ÏóîÎìúÌè¨Ïù∏Ìä∏)
apiVersion: v1
kind: Service
metadata:
  name: mongodb-svc
  namespace: db
  labels: { app: mongodb }
spec:
  selector: { app: mongodb }
  ports:
    - name: mongo
      port: 27017
      targetPort: 27017
  type: ClusterIP
---
# StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
  namespace: db
spec:
  serviceName: mongodb
  replicas: 1
  selector:
    matchLabels: { app: mongodb }
  template:
    metadata:
      labels: { app: mongodb }
    spec:
      containers:
        - name: mongod
          image: mongo:4.4
          imagePullPolicy: IfNotPresent
          command: ["mongod"]
          args: ["--bind_ip_all","--port=27017"]
          ports:
            - containerPort: 27017
          volumeMounts:
            - name: data
              mountPath: /data/db
          startupProbe:
            tcpSocket: { port: 27017 }
            periodSeconds: 5
            failureThreshold: 60
          livenessProbe:
            tcpSocket: { port: 27017 }
            initialDelaySeconds: 20
            periodSeconds: 10
          readinessProbe:
            tcpSocket: { port: 27017 }
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            requests: { cpu: "200m", memory: "512Mi" }
            limits:   { cpu: "1",    memory: "1Gi" }
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      storageClassName: local-path 
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 5Gi
---
# ReplicaSet Ï¥àÍ∏∞Ìôî Job (ÏàòÎèô Ïã§Ìñâ ÌïÑÏöî)
apiVersion: batch/v1
kind: Job
metadata:
  name: mongodb-rs-init
  namespace: db
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: rs-init
          image: mongo:4.4
          imagePullPolicy: IfNotPresent
          command: ["bash","-lc"]
          args:
            - |
              set -e
              echo "[rs-init] wait members"
              until mongo --host "mongodb.db.svc.cluster.local:27017" --eval 'db.adminCommand("ping")' >/dev/null 2>&1; do
                echo "  - mongodb not ready yet..."
                sleep 2
              done
              if mongo --host "mongodb.db.svc.cluster.local:27017" --eval "rs.status().ok" 2>/dev/null | grep -q ': 1'; then
                echo "[rs-init] already initiated"; exit 0
              fi
              echo "[rs-init] initiate"
              mongo --host "mongodb.db.svc.cluster.local:27017" --eval '
                rs.initiate({
                  _id: "rs0",
                  members: [
                    {_id:0, host:"mongodb.db.svc.cluster.local:27017"}
                  ]
                })
              '
              echo "[rs-init] done"

# ========== 5) Backend Deployment ==========
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mbti-backend
  namespace: backend
spec:
  replicas: 2
  selector:
    matchLabels: { app: mbti-backend }
  template:
    metadata:
      labels: { app: mbti-backend }
    spec:
      initContainers:
      - name: wait-mongo
        image: mongo:4.4
        command: ["bash","-lc"]
        args:
        - |
          set -e
          echo "[wait-mongo] ping mongodb RS"
          until mongo --host mongodb-svc.db.svc.cluster.local:27017 --eval 'db.adminCommand("ping")' >/dev/null 2>&1; do
            echo wait-mongo; sleep 2;
          done
      - name: wait-redis
        image: busybox:1.36
        command: ["/bin/sh","-lc"]
        args:
        - |
          set -e
          echo "[wait-redis] redis-external.backend.svc.cluster.local:6379"
          until nc -zvw5 redis-external.backend.svc.cluster.local 6379; do
            echo "waiting redis..."; sleep 2;
          done
      containers:
        - name: app
          image: xinuun/mbti:backend_final_pro 
          imagePullPolicy: IfNotPresent
          env:
            - name: PORT
              value: "8080"
            - name: MONGODB_URI
              value: "mongodb://mongodb.db.svc.cluster.local:27017/guestbook?replicaSet=rs0"
            - name: GUESTBOOK_DB_ADDR
              value: "mongodb-svc.db.svc.cluster.local:27017"
            - name: REDIS_HOST
              value: "redis-external.backend.svc.cluster.local"
            - name: REDIS_PORT
              value: "6379"
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: openai-secret
                  key: OPENAI_API_KEY
          ports:
            - name: http
              containerPort: 8080
          readinessProbe:
            httpGet: { path: /api/saju/healthz, port: http }
            initialDelaySeconds: 10
            periodSeconds: 5
          livenessProbe:
            httpGet: { path: /api/saju/healthz, port: http }
            initialDelaySeconds: 30
            periodSeconds: 10
          resources:
            requests: { cpu: "200m", memory: "256Mi" }
            limits:   { cpu: "1",    memory: "512Mi" }
---
apiVersion: v1
kind: Service
metadata:
  name: mbti-backend
  namespace: backend
spec:
  selector: { app: mbti-backend }
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  type: ClusterIP

# ========== 6) Frontend Deployment ==========
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mbti-frontend
  namespace: frontend
spec:
  replicas: 2
  selector:
    matchLabels: { app: mbti-frontend }
  template:
    metadata:
      labels: { app: mbti-frontend }
    spec:
      containers:
        - name: web
          image: xinuun/mbti:frontend_v2
          imagePullPolicy: IfNotPresent
          env:
            - name: PORT
              value: "80"
            # üö® [Ï£ºÏùò] app.js ÏΩîÎìúÎäî ÏÉÅÎåÄ Í≤ΩÎ°ú '/api/'Î•º ÏÇ¨Ïö©Ìï¥Ïïº Ìï©ÎãàÎã§.
            - name: GUESTBOOK_API_ADDR
              value: "mbti-backend.backend.svc.cluster.local:8080"
          ports:
            - name: http
              containerPort: 80
          livenessProbe:
            tcpSocket: { port: 80 }
            initialDelaySeconds: 15
            periodSeconds: 10
          readinessProbe:
            tcpSocket: { port: 80 }
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            requests: { cpu: "100m", memory: "128Mi" }
            limits:   { cpu: "500m", memory: "256Mi" }
---
apiVersion: v1
kind: Service
metadata:
  name: mbti-frontend
  namespace: frontend
spec:
  selector: { app: mbti-frontend }
  ports:
    - name: http
      port: 80
      targetPort: 80
  type: ClusterIP

# ========== 7) Ingress (ÌÜµÌï©) ==========
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: frontend-ing
  namespace: frontend
spec:
  ingressClassName: nginx
  rules:
  - host: mbti.local 
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: mbti-frontend
            port: { number: 80 }
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: backend-ing
  namespace: backend
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2 
spec:
  ingressClassName: nginx
  rules:
  - host: mbti.local
    http:
      paths:
      - path: /api(/|$)(.*) 
        pathType: ImplementationSpecific
        backend:
          service:
            name: mbti-backend
            port: { number: 8080 }